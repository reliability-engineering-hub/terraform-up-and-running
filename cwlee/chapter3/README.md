# 3. ν…λΌνΌ μƒνƒ κ΄€λ¦¬ν•κΈ°

## 01. ν…λΌνΌ μƒνƒλ€?
ν…λΌνΌμ„ μ‹¤ν–‰ν•  λ•λ§λ‹¤ ν…λΌνΌμ€ μƒμ„±ν• μΈν”„λΌμ— λ€ν• μ •λ³΄λ¥Ό ν…λΌνΌ μƒνƒ νμΌ(`terraform.tfstate`)μ— κΈ°λ΅ν•λ‹¤.
μ΄ νμΌμ—λ” κµ¬μ„± νμΌ(.tf)μ ν…λΌνΌ λ¦¬μ†μ¤κ°€ μ‹¤μ  λ¦¬μ†μ¤μ ν‘ν„μΌλ΅ λ§¤ν•‘λλ” λ‚΄μ©μ„ κΈ°λ΅ν•λ” μ‚¬μ©μ μ •μ `JSON`ν•μ‹μ΄ ν¬ν•¨λμ–΄ μλ‹¤.

</br>

### μƒνƒ κ΄€λ¦¬ λ°©λ²•
1. `terraform apply`
2. `terraform.tfstate` νμΌ μƒμ„±λλ‹¤.
3. ν…λΌνΌμ„ μ‹¤ν–‰ν•  λ•λ§λ‹¤ AWSμ—μ„ λ¦¬μ†μ¤μ μµμ‹  μƒνƒλ¥Ό κ°€μ Έμ™€ ν…λΌνΌμ κµ¬μ„±κ³Ό λΉ„κµν•λ‹¤.
   - `plan` λ…λ Ήμ μ¶λ ¥μ€ μƒνƒ νμΌμ IDλ¥Ό ν†µν•΄ λ°κ²¬λ μ»΄ν“¨ν„°μ μ½”λ“μ™€ μ‹¤μ  μ„Έκ³„μ— λ°°ν¬λ μΈν”„λΌ κ°„μ μ°¨μ΄μ΄λ‹¤.

</br>

```
π“ μ°Έκ³  : μƒνƒ νμΌμ€ ν”„λΌμ΄λΉ— APIμ΄λ‹¤.
μƒνƒ νμΌμ€ λ°°ν¬ν•  λ•λ§λ‹¤ λ³€κ²½λλ” ν”„λΌμ΄λΉ— APIλ΅, μ¤μ§ ν…λΌνΌ λ‚΄λ¶€μ—μ„ μ‚¬μ©ν•κΈ° μ„ν• κ²ƒμ΄λ‹¤.
ν…λΌνΌ μƒνƒ νμΌμ„ μ§μ ‘ νΈμ§‘ν•κ±°λ‚ μ§μ ‘ μ½λ” μ½”λ“λ¥Ό μ‘μ„±ν•΄μ„λ” μ•λλ‹¤.
μƒνƒ νμΌμ„ μ΅°μ‘ν•΄μ•Ό ν•λ” κ²½μ° terraform import λλ” terraform state λ…λ Ήμ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.
```

</br>

### ν€ λ‹¨μ„λ΅ μƒνƒ κ΄€λ¦¬ν•κΈ°
ν…λΌνΌμ„ μ‹¤μ  μ΄μ ν™κ²½μ—μ„ ν€ λ‹¨μ„λ΅ μ‚¬μ©ν•κ³ μ ν•  λ•λ” λ‹¤μκ³Ό κ°™μ€ λ¬Έμ κ°€ λ°μƒν•λ‹¤.
1. μƒνƒ νμΌμ„ μ €μ¥ν•λ” κ³µμ  μ¤ν† λ¦¬μ§€
   - ν…λΌνΌμ„ μ‚¬μ©ν•μ—¬ μΈν”„λΌλ¥Ό μ—…λ°μ΄νΈν•λ ¤λ©΄ κ° ν€μ›μ΄ λ™μΌν• ν…λΌνΌ μƒνƒ νμΌμ— μ—‘μ„Έμ¤ν•΄μ•Όν•λ‹¤. μ¦‰, μƒνƒ νμΌμ„ κ³µμ  μ„μΉμ— μ €μ¥ν•΄μ•Ό ν•λ‹¤.
2. μƒνƒ νμΌ μ κΈ
   - μƒνƒ λ°μ΄ν„°κ°€ κ³µμ λμλ§μ `μ κΈ(locking)`μ΄λΌλ” μƒλ΅μ΄ λ¬Έμ κ°€ λ°μƒν•λ‹¤.
   - μ κΈ κΈ°λ¥ μ—†μ΄ λ‘ ν€μ›μ΄ λ™μ‹μ— ν…λΌνΌμ„ μ‹¤ν–‰ν•λ” κ²½μ° `κ²½μ μƒνƒ(race condition)`μ— μ²ν•΄ λ°μ΄ν„°κ°€ μ†μ‹¤λκ±°λ‚ μƒνƒ νμΌμ΄ μ†μƒλ  μ μλ‹¤.
3. μƒνƒ νμΌ κ²©λ¦¬
   - μΈν”„λΌλ¥Ό λ³€κ²½ν•  λ•λ” λ‹¤λ¥Έ ν™κ²½μ„ κ²©λ¦¬ν•λ” κ²ƒμ΄ κ°€μ¥ μΆ‹λ‹¤.
   - ν…μ¤νΈ λλ” μ¤ν…μ΄μ§• ν™κ²½μ„ λ³€κ²½ν•  λ• μ‹¤μλ΅ ν”„λ΅λ•μ… ν™κ²½μ΄ μ¤‘λ‹¨λλ” κ²½μ°λ” μ—†λ”μ§€ ν™•μΈν•΄μ•Ό ν•λ‹¤.

</br>

---

## 02. μƒνƒ νμΌ κ³µμ 

### π‘ λ²„μ „ κ΄€λ¦¬ λ„κµ¬λ¥Ό μ΄μ©ν• κ΄€λ¦¬
μ—¬λ¬ λ…μ ν€μ›μ΄ νμΌμ— κ³µν†µμΌλ΅ μ—‘μ„Έμ¤ν•  μ μκ² ν•λ” κ°€μ¥ μΌλ°μ μΈ λ°©λ²•μ€ νμΌμ„ κΉƒκ³Ό κ°™μ€ λ²„μ „ κ΄€λ¦¬ μ‹μ¤ν…μ— λ‘λ” κ²ƒμ΄λ‹¤.
κ·Έλ¬λ‚ ν…λΌνΌ μƒνƒ νμΌμ„ λ²„μ „ κ΄€λ¦¬ μ‹μ¤ν…μ— μ €μ¥ν•λ” κ²ƒμ€ λ‹¤μκ³Ό κ°™μ€ μ΄μ  λ•λ¬Έμ— `λ¶€μ ν•©`ν•λ‹¤.
1. μλ™ μ¤λ¥
   - ν…λΌνΌμ„ μ‹¤ν–‰ν•κΈ° μ „μ— μµμ‹  λ³€κ²½ μ‚¬ν•­μ„ κ°€μ Έμ¤κ±°λ‚ μ‹¤ν–‰ν•κ³  λ‚μ„ ν‘Έμ‹ν•λ” κ²ƒμ„ μκΈ° μ‰½λ‹¤.
2. μ κΈ
   - λ€λ¶€λ¶„μ λ²„μ „ κ΄€λ¦¬ μ‹μ¤ν…μ€ μ—¬λ¬ λ…μ κµ¬μ„±μ›μ΄ λ™μ‹μ— ν•λ‚μ μƒνƒ νμΌμ— terraform apply λ…λ Ήμ„ μ‹¤ν–‰ν•μ§€ λ»ν•κ² ν•λ” μ κΈ κΈ°λ¥μ„ μ κ³µν•μ§€ μ•λ”λ‹¤.
3. μ‹ν¬λ¦Ώ
   - ν…λΌνΌ μƒνƒ νμΌμ λ¨λ“  λ°μ΄ν„°λ” ν‰λ¬ΈμΌλ΅ μ €μ¥λλ”λ° νΉμ • ν…λΌνΌ λ¦¬μ†μ¤μ— μ¤‘μ”ν• λ°μ΄ν„°λ¥Ό μ €μ¥ν•΄μ•Ό ν•  λ• λ¬Έμ κ°€ λ°μƒν•λ‹¤.

</br>

### π‘ ν…λΌνΌ λ°±μ—”λ“λ¥Ό μ΄μ©ν• κ΄€λ¦¬
κ°€μ¥ μΆ‹μ€ λ°©λ²•μ€ ν…λΌνΌμ— λ‚΄μ¥λ μ›κ²© λ°±μ—”λ“ κΈ°λ¥μ„ μ‚¬μ©ν•λ” κ²ƒμ΄λ‹¤.
`ν…λΌνΌ λ°±μ—”λ“`λ” ν…λΌνΌμ΄ μƒνƒλ¥Ό λ΅λ“ν•κ³  μ €μ¥ν•λ” λ°©λ²•μ„ κ²°μ •ν•λ‹¤.

</br>

- `λ΅μ»¬ λ°±μ—”λ“(κΈ°λ³Έ λ°±μ—”λ“)` - λ΅μ»¬ λ””μ¤ν¬μ— μƒνƒ νμΌ μ €μ¥
- `μ›κ²© λ°±μ—”λ“` - μ›κ²© κ³µμ  μ €μ¥μ†μ— μƒνƒ νμΌ μ €μ¥.
  - μ•„λ§μ΅΄ S3, μ• μ € μ¤ν† λ¦¬μ§€, κµ¬κΈ€ ν΄λΌμ°λ“ μ¤ν† λ¦¬μ§€, ν•΄μ‹μ½”ν”„μ ν…λΌνΌ ν΄λΌμ°λ“, ν…λΌνΌ ν”„λ΅, ν…λΌνΌ μ—”ν„°ν”„λΌμ΄μ¦ λ“±
  - λ‹¤μμ μ„Έ κ°€μ§€ λ¬Έμ  ν•΄κ²°
    1. μλ™ μ¤λ¥
       - μ›κ²© λ°±μ—”λ“λ¥Ό κµ¬μ„±ν•λ©΄ ν…λΌνΌμ€ planμ΄λ‚ apply λ…λ Ήμ„ μ‹¤ν–‰ν•  λ•λ§λ‹¤ ν•΄λ‹Ή λ°±μ—”λ“μ—μ„ μƒνƒ νμΌμ„ μλ™μΌλ΅ λ΅λ“ν•λ‹¤. 
    2. μ κΈ
       - λ€λ¶€λ¶„μ μ›κ²© λ°±μ—”λ“λ” κΈ°λ³Έμ μΌλ΅ μ κΈ κΈ°λ¥μ„ μ§€μ›ν•λ‹¤.
       - `terraform apply` λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ©΄ ν…λΌνΌμ€ μλ™μΌλ΅ μ κΈμ„ ν™μ„±ν™”ν•λ‹¤.
       - `-lock-timeout=<TIME>` λ§¤κ° λ³€μλ¥Ό μ‚¬μ©ν•λ©΄ apply λ…λ Ήμ„ μ‹¤ν–‰ν•  λ• μ κΈμ΄ ν•΄μ λκΈ°κΉμ§€ ν…λΌνΌμ΄ μ–Όλ§ λ™μ• λ€κΈ°ν•λ„λ΅ ν• μ§€ μ„¤μ •ν•  μ μλ‹¤.
    3. μ‹ν¬λ¦Ώ
       - λ€λ¶€λ¶„μ μ›κ²© λ°±μ—”λ“λ” κΈ°λ³Έμ μΌλ΅ λ°μ΄ν„°λ¥Ό λ³΄λ‚΄κ±°λ‚ μƒνƒ νμΌμ„ μ €μ¥ν•  λ• μ•”νΈν™”ν•λ” κΈ°λ¥μ„ μ§€μ›ν•λ‹¤.
  - ν…λΌνΌμ„ AWSμ™€ ν•¨κ» μ‚¬μ©ν•λ” κ²½μ° μ•„λ§μ΅΄μ΄ κ΄€λ¦¬ν•λ” νμΌ μ €μ¥μ†μΈ μ•„λ§μ΅΄ `S3(Simple Storage Service)`κ°€ κ°€μ¥ μ ν•©ν•λ‹¤.
    ```
    π‘ μ¥μ 
    - κ΄€λ¦¬ν• μ„λΉ„μ¤μ΄λ―€λ΅ μ¶”κ°€ μΈν”„λΌλ¥Ό λ°°ν¬ν•κ³  κ΄€λ¦¬ν•  ν•„μ”κ°€ μ—†λ‹¤.
    - 99.9999999999%μ λ‚΄κµ¬μ„±κ³Ό 99.99%μ κ°€μ©μ„±μ„ μ κ³µν•λ„λ΅ μ„¤κ³„λμ—μΌλ―€λ΅ λ°μ΄ν„° μ†μ‹¤ λλ” μ„λΉ„μ¤ μ¤‘λ‹¨μ„ κ±±μ •ν•  ν•„μ”κ°€ μ—†λ‹¤.
    - μ•”νΈν™”λ¥Ό μ§€μ›ν•λ―€λ΅ μƒνƒ νμΌμ— λ―Όκ°ν• λ°μ΄ν„°λ¥Ό μ €μ¥ν•  λ• μ•μ •μ„±μ„ λ†’μΈλ‹¤.
    - μ•„λ§μ΅΄ λ‹¤μ΄λ‚λ¨DBλ¥Ό ν†µν• μ κΈ κΈ°λ¥μ„ μ§€μ›ν•λ‹¤.
    - λ²„μ „ κ΄€λ¦¬λ¥Ό μ§€μ›ν•λ―€λ΅ μƒνƒ νμΌμ μμ • μ‚¬ν•­μ΄ λ¨λ‘ μ €μ¥λλ‹¤. λ΅¤λ°±μ΄ κ°€λ¥ν•λ‹¤.
    ```

</br>

### μ›κ²© μ €μ¥μ† S3 bucket μƒμ„±
1. 4κ°€μ§€ μΈμλ¥Ό μ„¤μ •ν•λ‹¤.
   ```
   1. bucket
   2. lifecycle
   3. versioning
   4. server_side_encryption_configuration
   ```
    ```
    resource "aws_s3_bucket" "terraform_state" {
        bucket = "terraform-up-and-running-state"

        # μ‹¤μλ΅ λ²„ν‚·μ„ μ‚­μ ν•λ” κ²ƒμ„ λ°©μ§€ν•λ‹¤.
        lifecycle {
            prevent_destroy = true
        }

        # μ½”λ“ μ΄λ ¥μ„ κ΄€λ¦¬ν•κΈ° μ„ν•΄ μƒνƒ νμΌμ λ²„μ „ κ΄€λ¦¬λ¥Ό ν™μ„±ν™”ν•λ‹¤.
        versioning {
            enabled = true
        }

        # μ„λ²„ μΈ΅ μ•”νΈν™”λ¥Ό ν™μ„±ν™” ν•λ‹¤.
        server_side_encryption_configuration {
        rule {
            apply_server_side_encryption_by_default {
            sse_algorithm = "AES256"
            }
        }
        }
    }
    ```
    ```
    π”‘ μ„λ²„ μΈ΅ μ•”νΈν™”λ€? 
    --> S3 λ²„ν‚·μ— κΈ°λ΅λ λ¨λ“  λ°μ΄ν„°μ— <<μ„λ²„ μΈ΅ μ•”νΈν™”>>λ¥Ό μ„¤μ •ν•λ‹¤.

    μ›Ή μ‚¬μ΄νΈμ κ²½μ° μ™Έλ¶€μ— κ³µκ°ν•λ” μ •λ³΄κ°€ μ•„λ‹ μ΄μƒ S3μ— μ €μ¥ν•λ” λ°μ΄ν„°λ” κΈ°λ³Έμ μΌλ΅ μ•”νΈν™”ν•  ν•„μ”κ°€ μλ‹¤.
    λ€κ° S3 λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ” λ°©μ‹μ€ ν¬κ² λ‘κ°€μ§€ λ°©μ‹μ΄ μλ‹¤.
    1. λ°μ΄ν„°λ¥Ό μ €μ¥ν•  λ• μ•”νΈν™” KEYλ¥Ό μ΄μ©ν•΄ μ•”νΈν™”/λ³µνΈν™”λ¥Ό κ΄€λ¦¬ν•λ‹¤.
    2. Amazonμ μ•”νΈν™”λ API μ—”λ“ν¬μΈνΈλ¥Ό μ΄μ©ν•΄ S3μ—μ„ λ‹¤λ¥Έ μ„λΉ„μ¤ λλ” λ¦¬μ†μ¤λ΅ μ „μ†΅λλ” λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ‹¤.

    π“ S3 Keyλ΅ μ•”νΈν™” ν•κΈ°
    ν‚¤λ¥Ό μ΄μ©ν•΄ S3 λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•  λ• μ–΄λ μ£Όμ²΄ κΈ°μ¤€μΌλ΅ μ•”νΈν™”ν•λ”μ§€μ— λ”°λΌ, μ„λ²„μΈ΅κ³Ό ν΄λΌμ΄μ–ΈνΈλ΅ λ‚λ‰κ² λλ‹¤.
    - μ„λ²„μΈ΅ μ•”νΈν™”
    - μ„λ²„ μΈ΅ μ•”νΈν™”λ” λ°μ΄ν„°λ¥Ό λ°›λ” μ• ν”λ¦¬μΌ€μ΄μ… λλ” μ„λΉ„μ¤μ— μν•΄ λ°μ΄ν„°λ¥Ό μ•”νΈν™”ν•λ” κ²ƒμ΄λ‹¤.
    - μ„λ²„μΈ΅ μ•”νΈν™”λ” S3 ν”λ«νΌ λ‚΄μ—μ„ μ§„ν–‰λλ©°, λ””μ¤ν¬μ— μ €μ¥λ  λ• λ°μ΄ν„° κ°μ²΄λ¥Ό μ•”νΈν™”ν•κ³ , μ μ ν• κ¶ν• μ¦λΉ™μ„ ν†µν•΄ λ°μ΄ν„° μΈμ¶μ„ μ”μ²­ν•  λ• λ³µνΈν™”ν•΄ μ „μ†΅ν•λ‹¤.
    - μ„λ²„μΈ΅μ—μ„ S3μ—μ„ μ•”νΈν™”λ¥Ό ν•λ” λ°©λ²•μ€ μ΄ 3κ°€μ§€κ°€ μλ”λ° κ·Έ μ¤‘ SSE-S3λ¥Ό μ‚΄ν΄λ³Έλ‹¤.

    π“ SSE-S3
    - μ•„λ§μ΅΄ S3μ—μ„ κ΄€λ¦¬ν•λ” ν‚¤λ¥Ό μ‚¬μ©ν•μ—¬ μ•”νΈν™”ν•λ” λ°©λ²•μ΄λ‹¤.
    S3 mamaged data keyλ” S3μ— μν•΄ μ™„μ „ν μ†μ λκ³  κ΄€λ¦¬ λλ‹¤.
    - AES-256 μ•κ³ λ¦¬μ¦μ„ μ΄μ©ν•΄ μ•”νΈν™” ν•λ‹¤.
    - μ„λ²„μ—μ„ μ•”νΈν™” ν•λ„λ΅ λ§λ“¤κΈ° μ„ν•΄μ„λ” ν—¤λ”μ— μ•„λ λ‚΄μ©μ„ λ³΄λ‚΄μ•Ό ν•λ‹¤.
    - "x-amz-server-side-encryption": "AES256" (amzλ” amazonμ μ•½μμ΄λ‹¤)

    μ•„λμ κ³Όμ •μ„ κ±°μ³ μ•”νΈν™” λλ‹¤.
    1. μ•”νΈν™”λμ§€ μ•μ κ°μ²΄λ¥Ό S3λ΅ μ—…λ΅λ“ν•μ—¬ SSE-S3 μ•”νΈν™”λ¥Ό ν•  κ²ƒμ΄λ‹¤.
    2. S3 λ΅ κ°μ²΄λ¥Ό μ „μ†΅ν•  λ• HTTP/HTTPS ν”„λ΅ν† μ½λ΅ ν—¤λ”μ— "x-amz-server-side-encryption":"AES256" μ„ μ„¤μ •ν•΄ μ „μ†΅ν•λ‹¤.
    3. κ·Έλ¬λ©΄ Amazon S3 λ” μ΄ ν—¤λ”λ¥Ό ν†µν•΄ S3 Managed Data Key λ΅ μ „μ†΅λ°›μ€ Object λ¥Ό μ•”νΈν™” ν•κ³  μ €μ¥ν•λ‹¤.
    4. μ¦‰, S3 μ—μ„ μ•”νΈν™” ν•λ” λ°μ΄ν„° ν‚¤λ¥Ό μ†μ ν•κ³  κ΄€λ¦¬ν•κ³  μλ” λ°©μ‹μ΄λ‹¤.
    ```
    μ°Έκ³  μ‚¬μ΄νΈ : [[AWS] π“ S3 κ°μ²΄ μ•”νΈν™” κΈ°λ¥ μΆ…λ¥ λ° μ‚¬μ©ν•κΈ°](https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-S3-%EA%B0%9D%EC%B2%B4-%EC%95%94%ED%98%B8%ED%99%94-%EA%B8%B0%EB%8A%A5-%EC%A2%85%EB%A5%98-%EB%B0%8F-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0)

2. DynamoDB ν…μ΄λΈ” μƒμ„±ν•κΈ°
- μ•„λ§μ΅΄μ λ¶„μ‚°ν• ν‚¤-κ°’ μ €μ¥μ†
- λ¶„μ‚° μ κΈ μ‹μ¤ν…μ— ν•„μ”ν• κ°•λ ¥ν• μ½κΈ° μΌκ΄€μ„± λ° μ΅°κ±΄λ¶€ μ“°κΈ°λ¥Ό μ§€μ›ν•λ‹¤.
  1. `LockID`λΌλ” κΈ°λ³Έ ν‚¤κ°€ μλ” Dynamo table μƒμ„±ν•κΈ° (aws_dynamodb_table)
     ```
      resource "aws_dynamodb_table" "terraform_locks" {
         name         = "terraform-up-and-running-locks"
         billing_mode = "PAY_FOR_REQUEST"
         hash_key     = "LockID"

         attribute {
            name = "LockID"
            type = "S"
         }
      }
     ```

3. backend λ§λ“¤κΈ°
   S3 λ²„ν‚·μ— μƒνƒλ¥Ό μ €μ¥(μ•”νΈν™” λ° μ κΈμ„ μ‚¬μ©)ν•λ„λ΅ ν…λΌνΌμ„ κµ¬μ„±ν•λ ¤λ©΄ ν…λΌνΌ μ½”λ“ λ‚΄μ— backend κµ¬μ„±μ„ μ„¤μ •ν•΄μ•Ό ν•λ‹¤.
   ```
   terraform {
      backend "<BACKEND_NAME>" { # μ‚¬μ©ν•λ ¤λ” λ°±μ—”λ“μ μ΄λ¦„
         [CONFIG...]
      }
   }
   ```
   ```
   π“ Config κ°’
   bucket         : μ‚¬μ©ν•  S3 λ²„ν‚·μ μ΄λ¦„
   key            : ν…λΌνΌ μƒνƒ νμΌμ„ μ €μ¥ν•  S3 λ²„ν‚· λ‚΄μ νμΌ κ²½λ΅
   region         : S3 λ²„ν‚·μ΄ μλ” AWSμ λ¦¬μ „
   dynamodb_table : μ κΈμ— μ‚¬μ©ν•  dynamoDB ν…μ΄λΈ”
   encypt         : trueλ΅ μ„¤μ •μ‹ ν…λΌνΌ μƒνƒκ°€ S3 λ””μ¤ν¬μ— μ €μ¥λ  λ• μ•”νΈν™”λ¨.
   ```

</br>

### κ²°κ³Ό
ν…λΌνΌμ€ S3μ— μƒνƒ λ°μ΄ν„°λ¥Ό μλ™μΌλ΅ ν‘Έμ‹ν•κ±°λ‚ κ°€μ Έμ¤κ³  S3κ°€ μƒνƒ νμΌμ λ¨λ“  λ³€κ²½ μ‚¬ν•­μ„ μ €μ¥ν•λ‹¤.
1. bucket μƒμ„± μ™„λ£ </br>
   <img src="./img/1.png" width="35%" height="35%"/>
2. dynamoDB μƒμ„± μ™„λ£ </br>
   <img src="./img/2.png" width="35%" height="35%"/>
3. terraform.tfstate νμΌ μ—…λ΅λ“ μ™„λ£ </br>
   <img src="./img/3.png" width="35%" height="35%"/>
4. λ²„μ €λ‹ μ •μƒ λ™μ‘ ν™•μΈ </br>
   <img src="./img/4.png" width="35%" height="35%"/>

</br>

---

## 03. ν…λΌνΌ λ°±μ—”λ“μ λ‹¨μ 
ν…λΌνΌμ„ μ‚¬μ©ν•μ—¬ ν…λΌνΌ μƒνƒλ¥Ό μ €μ¥ν•  S3 λ²„ν‚·μ„ λ§λ“λ” κ²ƒμ€ λ‹­μ΄ λ¨Όμ €μΈμ§€ λ‹¬κ±€μ΄ λ¨Όμ €μΈμ§€ λ¬»λ” κ²ƒκ³Ό κ°™λ‹¤.
1. ν…λΌνΌ λ¨λ“λ¥Ό μ‘μ„±ν•μ—¬ S3 λ²„ν‚·κ³Ό DynamoDB ν…μ΄λΈ”μ„ μƒμ„±ν•κ³  ν•΄λ‹Ή μ½”λ“λ¥Ό λ΅μ»¬ λ°±μ—”λ“μ™€ ν•¨κ» λ°°ν¬ν•λ‹¤.
2. ν…λΌνΌ μ½”λ“λ΅ λμ•„κ°€μ„ μ›κ²© backend κµ¬μ„±μ„ μ¶”κ°€ν•λ‹¤. μƒλ΅ μƒμ„±λ S3 λ²„ν‚·κ³Ό DynamonDB ν…μ΄λΈ”μ„ μ‚¬μ©ν•κ³ , terraform init λ…λ Ήμ„ μ‹¤ν–‰ν•μ—¬ λ΅μ»¬ μƒνƒλ¥Ό S3μ— λ³µμ‚¬ν•λ‹¤.

</br>

S3 λ²„ν‚·κ³Ό DynamoDB tableμ„ μ‚­μ ν•λ ¤λ©΄ μ΄ λ‹¨κ³„λ¥Ό λ°λ€λ΅ μν–‰ν•΄μ•Ό ν•λ‹¤.
1. ν…λΌνΌ μ½”λ“λ΅ μ΄λ™ν•μ—¬ backend κµ¬μ„±μ„ μ κ±°ν• λ‹¤μ terraform init λ…λ Ήμ„ μ¬μ‹¤ν–‰ν•μ—¬ ν…λΌνΌ μƒνƒλ¥Ό λ΅μ»¬ λ””μ¤ν¬μ— λ‹¤μ‹ λ³µμ‚¬ν•λ‹¤.
2. terraform destroy λ…λ Ήμ„ μ‹¤ν–‰ν•μ—¬ S3 λ²„ν‚· λ° DynamoDB tableμ„ μ‚­μ ν•λ‹¤.

</br>

ν…λΌνΌμ backend λΈ”λ΅μ—μ„λ” λ³€μλ‚ μ°Έμ΅°λ¥Ό μ‚¬μ©ν•  μ μ—†λ‹¤. </br>
μ¦‰, S3 λ²„ν‚· μ΄λ¦„, λ¦¬μ „, DynamoDb ν…μ΄λΈ” μ΄λ¦„ λ“±μ„ λ¨λ‘ ν…λΌνΌ λ¨λ“μ— μλ™μΌλ΅ λ³µμ‚¬ν•΄μ„ λ¶™μ—¬λ„£μ–΄μ•Ό ν•λ‹¤. </br>
λ°°ν¬ν•λ” λ¨λ“  ν…λΌνΌ λ¨λ“λ§λ‹¤ κ³ μ ν• keyλ¥Ό ν™•λ³΄ν•΄μ„ μ‹¤μλ΅ λ‹¤λ¥Έ λ¨λ“μ μƒνƒλ¥Ό λ®μ–΄μ“°μ§€ μ•λ„λ΅ ν•΄μ•Όν•λ‹¤. 
```
# λ°±μ—”λ“ κµ¬μ„±μ— λ³€μλ” ν—μ©λμ§€ μ•μΌλ―€λ΅ μ΄ μ½”λ“λ” μ‹¤ν–‰λμ§€ μ•λ”λ‹¤.
terraform {
   backend "s3" {
      bucket = var.bucket 
      ...
   }
}
```

μλ™ λ³€κ²½ μ‘μ—…μ„ μμ£Όν•λ©΄ μ—λ¬κ°€ λ°μƒν•κΈ° μ‰½λ‹¤. μ΄λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ </br>
`λ¶€λ¶„ κµ¬μ„±(partial configuration)`μ„ μ΄μ©ν•΄ terraform initμ„ νΈμ¶ν•  λ• `-backend-config` μΈμλ¥Ό ν†µν•΄ λ§¤κ° λ³€μλ¥Ό μ „λ‹¬ν•λ‹¤.
```
π“ λ°λ³µλλ” λ°±μ—”λ“ μΈμλ¥Ό backend.hclμ΄λΌλ” λ³„λ„μ νμΌλ΅ μ¶”μ¶ν•λ‹¤.
# backend.hcl
bucket         = "terraform-up-and-running-state"
region         = "us-east-3"
dynamodb_table = "terraform-up-and-running-locks"
encrypt        = true

π“ λ¨λ“λ§λ‹¤ μ„λ΅ λ‹¤λ¥Έ key κ°’μ— λ€ν•΄μ„λ§ ν…λΌνΌ μ½”λ“μ— μ‘μ„±ν•λ‹¤.
terraform {
   backend "s3" {
      key = "example/terraform.tfstate
   }
}

π“ -backend-config μΈμμ™€ ν•¨κ» terraform init λ…λ Ήμ„ μ‹¤ν–‰ν•λ‹¤.
$ terraform init -backend-config=backend.hcl
```

---

## 04. μƒνƒ νμΌ κ²©λ¦¬
λ¨λ“  μΈν”„λΌλ¥Ό λ‹¨ ν•λ‚μ ν…λΌνΌ νμΌλ΅ κ΄€λ¦¬ν•λ©΄ μ‹¤μλ΅ μ „μ²΄λ¥Ό λ‚ λ ¤λ²„λ¦΄ μ μλ‹¤. </br>
λ¶„λ¦¬λ ν™κ²½μ„ κ°–μ¶λ‹¤λ” κ²ƒμ€ ν•λ‚μ ν™κ²½μ„ λ‹¤λ¥Έ ν™κ²½μΌλ΅λ¶€ν„° κ²©λ¦¬ν•λ‹¤λ” κ²ƒμ΄λ‹¤. </br>
λ”°λΌμ„ λ‹¨ ν•λ‚μ ν…λΌνΌ κµ¬μ„± μ•μ—μ„ λ¨λ“  ν™κ²½μ„ κ΄€λ¦¬ν•κ³  μλ‹¤λ©΄ μ΄ `κ²©λ¦¬ μƒνƒ`λ¥Ό κΉ¨λ¨λ¦¬λ” κ²ƒμ΄λ‹¤. </br>

λ‹¤μκ³Ό κ°™μ΄ κ° ν™κ²½μ„ λ³„λ„μ κµ¬μ„± μ„ΈνΈλ΅ μ •μν•λ ¤ ν•λ‹¤. μƒνƒ νμΌμ„ κ²©λ¦¬ν•λ” 2κ°€μ§€ λ°©λ²•μ΄ μλ‹¤. </br>
    <img src="./img/5.png" width="25%" height="25%"/>
1. μ‘μ—… κ³µκ°„μ„ ν†µν• κ²©λ¦¬ - λ™μΌν• κµ¬μ„±μ—μ„ λΉ λ¥΄κ³  κ²©λ¦¬λ ν…μ¤νΈ ν™κ²½μ— μ μ©ν•λ‹¤.
2. νμΌ λ μ΄μ•„μ›ƒμ„ μ΄μ©ν• κ²©λ¦¬ - λ³΄λ‹¤ κ°•λ ¥ν•κ² λ¶„λ¦¬ν•΄μ•Ό ν•λ” μ΄μ ν™κ²½μ— μ ν•©ν•λ‹¤.

</br>

### 1. μ‘μ—… κ³µκ°„μ„ ν†µν• κ²©λ¦¬
- ν…λΌνΌμ€ μ‘μ—… κ³µκ°„(terraform workspace)μ„ ν†µν•΄ ν…λΌνΌ μƒνƒλ¥Ό λ³„λ„μ μ΄λ¦„μ„ κ°€μ§„ μ—¬λ¬ κ°μ μ‘μ—… κ³µκ°„μ— μ €μ¥ν•  μ μλ‹¤.
- ν…λΌνΌμ€ 'default'λΌλ” κΈ°λ³Έ μ‘μ—… κ³µκ°„μ—μ„ μ‹μ‘ν•λ©° μ‘μ—… κ³µκ°„μ„ λ”°λ΅ μ§€μ •ν•μ§€ μ•μΌλ©΄ κΈ°λ³Έ μ‘μ—… κ³µκ°„μ„ μ‚¬μ©ν•λ‹¤.
- μƒ μ‘μ—… κ³µκ°„μ„ μƒμ„±ν•κ±°λ‚ μ‘μ—… κ³µκ°„μ„ μ „ν™ν•λ ¤λ©΄ `terraform workspace` λ…λ Ήμ„ μ‚¬μ©ν•λ‹¤.

</br>

```
π’» Terraform Workspace λ…λ Ήμ–΄
$ terraform workspace show        # μ‘μ—… κ³µκ°„ ν™•μΈ ν•κΈ°
$ terraform workspace new example # μƒ μ‘μ—… κ³µκ°„ λ§λ“¤κΈ°
$ terraform workspace select      # μ‘μ—… κ³µκ°„ μ„ νƒν•κΈ°
```

</br>

1. [workspace - default] backend.tf 
    ```
    terraform {
    backend "s3" {
        # μ΄μ „μ— μƒμ„±ν• λ²„ν‚· μ΄λ¦„μΌλ΅ λ³€κ²½
        bucket = "terraform-up-and-running-state-lcw"
        key    = "workspace-example/s3/terraform.tfstate"
        region = "ap-northeast-2"

        # μ΄μ „μ— μƒμ„±ν• BynamoDB Table μ΄λ¦„μΌλ΅ λ³€κ²½
        dynamodb_table = "terraform-up-and-running-locks-lcw"
        encrypt        = true
    }
    }  
    ```
2. [workspace - default ] `terraform plan`
   ```
   Plan: 1 to add, 0 to change, 0 to destroy.
   ```
3. [workspace - default ] `terraform apply`
   ```
   Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
   ```
4. [workspace - example1] `terraform plan`
   - example1 workspaceλ” μ•„μ§ λ¦¬μ†μ¤κ°€ μƒμ„±λμ§€ μ•μ€ μƒνƒμ΄λ‹¤.
   ```
   Plan: 1 to add, 0 to change, 0 to destroy.
   ```
5. [workspace - example1] `terraform apply`
   ```
   Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
   ```
6. `terraform workspace list`
   ```
   default
   example1
   * example2
   ```

</br>

### S3 λ²„ν‚· λ””λ ‰ν„°λ¦¬ κµ¬μ΅° ν™•μΈν•κΈ°
- κ° μ‘μ—… κ³µκ°„ λ‚΄μ—μ„ ν…λΌνΌμ€ backend κµ¬μ„±μ—μ„ μ§€μ •ν• keyλ¥Ό μ‚¬μ©ν•λ‹¤.
- μ‘μ—… κ³µκ°„ λ§λ‹¤ λ³„λ„μ μƒνƒ νμΌμ΄ μμ–΄ λ‹¤λ¥Έ μ‘μ—… κ³µκ°„μΌλ΅ μ „ν™ν•λ” κ²ƒμ€ `μƒνƒ νμΌμ΄ μ €μ¥λ κ²½λ΅λ¥Ό λ³€κ²½ν•λ” κ²ƒ`κ³Ό κ°™λ‹¤. </br>
<img src="./img/6.png" width="35%" height="35%"/>

</br>

### κ° μ‘μ—… κ³µκ°„μ— λ‹¤λ¥Έ μ„¤μ • κ°’ μ μ©ν•κΈ°
- ν…μ¤νΈ λΉ„μ©μ„ μ κ°ν•κΈ° μ„ν•΄μ„ κΈ°λ³Έ μ‘μ—… κ³µκ°„μ—μ„ μΈμ¤ν„΄μ¤ μ ν•μ„ `t2.medium`μΌλ΅ μ„¤μ •ν•κ³  κ·Έ μ™Έμ μ‘μ—… κ³µκ°„μ€ `t2.micro`λ΅ μ„¤μ •ν•λ‹¤.
- 3ν•­ μ—°μ‚°μλ¥Ό μ‚¬μ©ν•λ‹¤.
   ```
   resource "aws_instance" "example" {
      ami = "ami-0e38c97339cddf4bd"
      instance-type = terraform.workspace == "default" ? "t2.medium" : "t2.micro"
   }
   ```

</br>

### ν…λΌνΌ μ‘μ—… κ³µκ°„μ λ‹¨μ 
1. λ¨λ“  μ‘μ—… κ³µκ°„μ μƒνƒ νμΌμ€ λ™μΌν• λ°±μ—”λ“(μλ¥Ό λ“¤μ–΄, λ™μΌν• S3 λ²„ν‚·)μ— μ €μ¥λλ‹¤. μ¦‰, λ¨λ“  μ‘μ—… κ³µκ°„μ΄ κ°™μ€ μΈμ¦ λ©”μ»¤λ‹μ¦μ„ μ‚¬μ©ν•λ‹¤.
2. terraform workspace λ…λ Ήμ„ μ‹¤ν–‰ν•μ§€ μ•μΌλ©΄ μ½”λ“λ‚ ν„°λ―Έλ„μ— μ‘μ—… κ³µκ°„μ— λ€ν• μ •λ³΄κ°€ ν‘μ‹ λμ§€ μ•λ”λ‹¤. </br>
   μ½”λ“λ¥Ό νƒμƒ‰ν•  λ•, ν• μ‘μ—… κ³µκ°„μ— λ°°μΉλ λ¨λ“μ€ λ‹¤λ¥Έ λ¨λ“  μ‘μ—… κ³µκ°„μ— λ°°μΉλ λ¨λ“κ³Ό μ •ν™•ν λ™μΌν•λ‹¤.
3. μ–΄λ–¤ μ‘μ—… κ³µκ°„μ— μλ”μ§€ λ³΄μ΄μ§€ μ•κΈ° λ•λ¬Έμ— ν„μ¬ μ‚¬μ© μ¤‘μΈ μ‘μ—… κ³µκ°„μ΄ μ–΄λ κ²ƒμΈμ§€ μμ–΄λ²„λ¦¬κΈ° μ‰½λ‹¤.

</br>

---
### 2. νμΌ λ μ•„μ•„μ›ƒμ„ μ΄μ©ν• κ²©λ¦¬
ν™κ²½μ„ μ™„μ „ν κ²©λ¦¬ν•λ ¤λ©΄ λ‹¤μ μ‘μ—…μ„ μν–‰ν•΄μ•Ό ν•λ‹¤.
- κ° ν…λΌνΌ κµ¬μ„± νμΌμ„ λ¶„λ¦¬λ ν΄λ”μ— λ„£λ”λ‹¤.
- μ„λ΅ λ‹¤λ¥Έ μΈμ¦ λ©”μ»¤λ‹μ¦κ³Ό μ—‘μ„Έμ¤ μ μ–΄λ¥Ό μ‚¬μ©ν•΄ κ° ν™κ²½μ— μ„λ΅ λ‹¤λ¥Έ λ°±μ—”λ“λ¥Ό κµ¬μ„±ν•λ‹¤.
  - κ° ν™κ²½μ€ κ°κ° λ¶„λ¦¬λ S3 λ²„ν‚·μ„ λ°±μ—”λ“λ΅ μ‚¬μ©ν•λ” λ³„λ„μ AWS κ³„μ •μ— μμ„ μ μλ‹¤.

</br>

### κµ¬μ„± μ”μ†(component)λ³„ ν…λΌνΌ ν΄λ” κ΄€λ¦¬ν•κΈ°
- `κµ¬μ„± μ”μ†`  : μΌλ°μ μΌλ΅ ν•¨κ» λ°°ν¬λλ” μΌκ΄€λ λ¦¬μ†μ¤ μ§‘ν•©
- κ¶μ¥λλ” νμΌ λ μ΄μ•„μ›ƒ </br>
  <img src="./img/7.png" width="35%" height="35%"/> </br>
  ```
  π“ ν™κ²½
   - stage  : ν…μ¤νΈ ν™κ²½κ³Ό κ°™μ€ μ‚¬μ „ ν”„λ΅λ•μ… μ›ν¬λ΅λ“ ν™κ²½
   - prod   : μ‚¬μ©μμ© λ§µ κ°™μ€ ν”„λ΅λ•μ… μ›ν¬λ΅λ“ ν™κ²½
   - mgmt   : Bastion Host, Jenkinsμ™€ κ°™μ€ λ°λΈμµμ¤ λ„κµ¬ ν™κ²½
   - global : S3, IAMκ³Ό κ°™μ΄ λ¨λ“  ν™κ²½μ—μ„ μ‚¬μ©λλ” λ¦¬μ†μ¤λ¥Ό λ°°μΉν•  μ μλ” μ¥μ†
  
  π“ κµ¬μ„± μ”μ†
   - vpc          : ν•΄λ‹Ή ν™κ²½μ„ μ„ν• λ„¤νΈμ›ν¬ ν† ν΄λ΅μ§€
   - services     : ν•΄λ‹Ή ν™κ²½μ—μ„ μ„λΉ„μ¤λλ” μ• ν”λ¦¬μΌ€μ΄μ… λλ” λ§μ΄ν¬λ΅μ„λΉ„μ¤. 
   - data-storage : MYSQL λλ” λ λ””μ¤μ™€ κ°™μ€ ν•΄λ‹Ή ν™κ²½μ—μ„ μ‹¤ν–‰ν•  λ°μ΄ν„° μ €μ¥μ†.
  ```
```
π“ μ°Έκ³  : μ½”λ“ μ¤‘λ³µ ν”Όν•κΈ°
νμΌ λ μ΄μ•„μ›ƒμ—λ” λ§μ€ λ³µμ λ³Έμ΄ λ°μƒν•λ‹¤.
4μ¥μ—μ„ ν…λΌνΌ λ¨λ“μ„ μ‚¬μ©ν•λ©° μ½”λ“λ¥Ό μ¤‘λ³µν•μ§€ μ•κ³  μ μ§€ν•λ” λ°©λ²•μ„ μ„¤λ…ν•λ‹¤.
```

</br>

### π‘ λ‹¨μ 
1. ν• λ²μ λ…λ ΉμΌλ΅ μ „μ²΄ μΈν”„λΌλ¥Ό λ§λ“¤μ§€ λ»ν•λ‹¤. 
   - [terragrant](https://terragrunt.gruntwork.io/)λ¥Ό μ‚¬μ©ν•λ” κ²½μ° apply-all λ…λ Ήμ„ μ‚¬μ©ν•μ—¬ μ΄ ν”„λ΅μ„Έμ¤λ¥Ό μλ™ν™”ν•  μ μλ‹¤.
2. λ¦¬μ†μ¤ μΆ…μ†μ„±μ„ μ‚¬μ©ν•κΈ° μ–΄λ µλ‹¤.
   - ν…λΌνΌμ€ `terraform_remote_state` λ°μ΄ν„° μ†μ¤ μ†”λ£¨μ…μ„ μ κ³µν•λ‹¤.

</br>

---

## 05. terraform_remote_state λ°μ΄ν„° μ†μ¤
`terraform_remote_state` λ°μ΄ν„° μ†μ¤λ¥Ό μ‚¬μ©ν•λ©΄ λ‹¤λ¥Έ ν…λΌνΌ κµ¬μ„± μ„ΈνΈμ— μ™„μ „ν• μ½κΈ° μ „μ© λ°©μ‹μΌλ΅ μ €μ¥λ ν…λΌνΌ μƒνƒ νμΌμ„ κ°€μ Έμ¬ μ μλ‹¤.

### [μμ ] μ›Ή μ„λ²„ ν΄λ¬μ¤ν„° <-> MySQl λ°μ΄ν„° λ² μ΄μ¤ ν†µμ‹ 
<img src="./img/8.png" width="35%" height="35%"/> </br>
- μ›Ή μ„λ²„ ν΄λ¬μ¤ν„°λ” MySQL λ°μ΄ν„°λ² μ΄μ¤λ³΄λ‹¤ ν›¨μ”¬ μμ£Ό λ°°ν¬ν•  κ²ƒμ΄λ‹¤. </br>
  μ΄ κ³Όμ •μ—μ„ μ‹¤μλ΅ λ°μ΄ν„°λ² μ΄μ¤λ¥Ό μ†μƒμ‹ν‚¤κ³  μ‹¶μ§€ μ•λ‹¤λ©΄ μ›Ή μ„λ²„ ν΄λ¬μ¤ν„°μ™€ MySQL λ°μ΄ν„° λ² μ΄μ¤ μ„¤μ • λ””λ ‰ν„°λ¦¬λ¥Ό λ¶„λ¦¬ν•΄μ•Ό ν•λ‹¤.  </br>
  ```
   β”β”€β”€ global
   β”‚   β””β”€β”€ s3
   β”‚       β”β”€β”€ main.tf
   β”‚       β”β”€β”€ outputs.tf
   β”‚       β”β”€β”€ providers.tf
   β”‚       β””β”€β”€ variables.tf
   β””β”€β”€ stage
      β”β”€β”€ data-stores
      β”‚   β””β”€β”€ mysql
      β”‚       β”β”€β”€ main.tf
      β”‚       β”β”€β”€ outputs.tf
      |       β”β”€β”€ providers.tf
      β”‚       β””β”€β”€ variables.tf
      β””β”€β”€ services
         β””β”€β”€ webserver-cluster
               β”β”€β”€ data.tf
               β”β”€β”€ main.tf
               β”β”€β”€ outputs.tf
               β””β”€β”€ variables.tf  
  ```

- stage/data-stores/mysql/main.tf
  - ν¨μ¤μ›λ“μ™€ κ°™μ€ μ •λ³΄λ” μ λ€ ν‰λ¬ΈμΌλ΅ μ…λ ¥ν•΄μ„λ” μ•λλ‹¤.
  - λ‹¤μμ λ‘ κ°€μ§€ λ°©λ²•μΌλ΅ ν¨μ¤μ›λ“λ¥Ό μ…λ ¥ν•  μ μλ‹¤.
  1. `AWS Secrets Manager`μ— μ €μ¥ν•κΈ°
      ```
      resource "aws_db_instance" "example" {
         identifier_prefix  = "terraform-up-and-running"
         engine             = "mysql"
         allocation_storage = 10 # 10G
         instance_class     = "db.t2.micro"
         name               = "example_database"
         username           = "admin"
         password           = data.aws_secretsmanager_secret_version.db_password.secret_string
      }

      data "aws_secretsmanager_secret_version" "db_password" {
         secret_id = "mysql-master-password-stage"
      }
      ``` 
  2. ν…λΌνΌ μ™Έλ¶€μ—μ„ κ΄€λ¦¬ν•κ³  ν™κ²½ λ³€μλ¥Ό ν†µν•΄ κ°’μ„ ν…λΌνΌμ— μ „λ‹¬ν•κΈ°
     - variables.tf
      ```
      variable "db_password" {
         description = "The password for the database"
         type        = string
      }       
      ``` 
      ```
      π“ μ°Έκ³  : μ‹ν¬λ¦Ώ κ°’μ€ ν•­μƒ ν…λΌνΌ μƒνƒμ— μ €μ¥λλ‹¤.
      μ‹ν¬λ¦Ώ κ°’μ„ μ–΄λ–¤ λ°©λ²•μΌλ΅ μ½λ“  κ°„μ— ν…λΌνΌ λ¦¬μ†μΉμ— μ‹ν¬λ¦Ώ κ°’μ„ μΈμλ΅ μ „λ‹¬ν•λ©΄ ν•΄λ‹Ή μ‹ν¬λ¦Ώ κ°’μ€ ν…λΌνΌ μƒνƒ νμΌμ— ν‰λ¬ΈμΌλ΅ μ €μ¥λλ‹¤.
      ν•­μƒ μ•”νΈν™”λ¥Ό μ‚¬μ©ν•λ” λ“± μƒνƒ νμΌμ„ μ €μ¥ν•  λ• νΉν μ£Όμν•΄μ•Ό ν•λ‹¤.
      IAM κ¶ν•μ„ μ‚¬μ©ν•΄ S3 λ²„ν‚·μ— λ€ν• μ—‘μ„Έμ¤λ¥Ό μ ν•ν•λ” λ“± μƒνƒ νμΌμ— μ—‘μ„Έμ¤ν•  μ μλ” μ‚¬μ©μλ¥Ό μ„Έμ‹¬ν•κ² νμ•…ν•κ³  κ΄€λ¦¬ν•΄μ•Ό ν•λ‹¤.
      ```
- stage/services/webserver-cluster/main.tf
  - `terraform_remote_state` λ°μ΄ν„° μ†μ¤ μ¶”κ°€ν•΄ μ›Ή μ„λ²„ ν΄λ¬μ¤ν„° μ½”λ“κ°€ DB μƒνƒ νμΌμ—μ„ λ°μ΄ν„°λ¥Ό μ½λ„λ΅ ν•λ‹¤.
      ```
         data "terraform_remote_state" "db" {
         backend = "s3" 

         config = {
            bucket = "terraform-up-and-running-state-lcw"
            key = "stage/data-stores/mysql/terraform.tfstate"
            }
         } 
      ```
      <img src="./img/9.png" width="35%" height="35%"/> </br>
  - λ¨λ“  λ°μ΄ν„°λ² μ΄μ¤μ μ¶λ ¥ λ³€μλ” μƒνƒ νμΌμ— μ €μ¥λλ©° λ‹¤μκ³Ό κ°™μ€ μ°Έμ΅°λ¥Ό μ΄μ©ν•΄ `terraform_remote_state` λ°μ΄ν„° μ†μ¤μ—μ„ μ½μ„ μ μλ‹¤.
    ```
    data.terraform_remote_state.<NAME>.outputs.<ATTRIBUTE>
    ```

- ν…λΌνΌ λ‚΄μ¥ ν•¨μλ¥Ό μ΄μ©ν•΄ λ°°μ‹ μ¤ν¬λ¦½νΈ μ™Έλ¶€ν™”ν•κΈ°
  - `template_file`μ„ μ΄μ©ν•΄ aws_laucnch_configuration.example.user_dataλ¥Ό μ„¤μ •ν–λ‹¤.
   ```
   π“ ν…λΌνΌμ λ‚΄μ¥ ν•¨μ
   ν…λΌνΌμ—λ” ν‘ν„μ‹μ„ μ‚¬μ©ν•μ—¬ μ‹¤ν–‰ν•  μ μλ” μ—¬λ¬ λ‚΄μ¥ ν•¨μκ°€ μλ‹¤.
   terraform console λ…λ Ήμ„ μ‹¤ν–‰ν•΄ λ€ν™”ν• μ½μ†” μ‚¬μ©ν•΄μ„ λ‚΄μ¥ ν•¨μ ν…μ¤νΈν•  μ μλ‹¤.

   1. format(<FMT>, <ARGS>, ...)
   > format("%.3f", 3.14159265359)
   "3.142"

   1. file(<PATH>)
   PATHμ—μ„ νμΌ μ½κ³  κ·Έ λ‚΄μ©μ„ λ¬Έμμ—΄λ΅ λ°ν™ν•λ‹¤.
   μλ¥Ό λ“¤μ–΄ μ‚¬μ©μ λ°μ΄ν„° μ¤ν¬λ¦½νΈλ¥Ό stage/services/webserver-cluster/user-data.shμ— λ„£κ³ 
   file("user-data.sh")λ΅ λ¬Έμμ—΄λ΅ λ‚΄μ©μ„ μ½μ„ μ μλ‹¤.


   3. template_file
   data "template_file" "user_data" {
      template = file("user-data.sh) # λλ”λ§ν•  λ¬Έμμ—΄

      vars = { # λλ”λ§ μ¤‘μ— μ‚¬μ©ν•  λ³€μμ λ§µ
         server_port = var.server_port
         db_address  = data.terraform_remote_state.db.outputs.address
         db_port     = data.terraform_remote_state.db.outputs.port
      }
   }
   ```
   ```
   π“ μ°Έκ³  : μ™Έλ¶€ν™”λ νμΌ
   μ‚¬μ©μ λ°μ΄ν„° μ¤ν¬λ¦½νΈλ¥Ό λ³„λ„μ μμ²΄ νμΌλ΅ μ¶”μ¶ν•λ©΄ μλ™ν™”λ λ‹¨μ„ ν…μ¤νΈ μ½”λ“λ¥Ό μ‘μ„±ν•  μ μλ‹¤λ” μ΄μ μ΄ μλ‹¤.
   ν™κ²½ λ³€μλ¥Ό μ°Ύλ” λ°°μ‹ κµ¬λ¬Έμ€ ν…λΌνΌμ λ³΄κ°„ κµ¬λ¬Έκ³Ό λ™μΌν•κΈ° λ•λ¬Έμ— ν…μ¤νΈ μ½”λ“λ” ν™κ²½ λ³€μλ¥Ό μ‚¬μ©ν•μ—¬ λ³΄κ°„λ λ³€μλ¥Ό μ±„μΈ μλ„ μλ‹¤.
   [μμ‹ μ½”λ“]
   export db_address=12.24.XX.XX
   export db_port=5555
   export server_port=8888

   ./user-data.sh

   output=$(curl "http://localhost:$server_port")

   if [[ $output == *"Hello, World"* ]], then
      echo "Success!"
   else
      echo "Error"
   fi
   ```

</br>

---

## 06. κ²°λ΅ 
κ²©λ¦¬, μ κΈ λ° μƒνƒμ— λ€ν•΄ λ§μ€ κ³ λ―Όμ„ ν•΄μ•Ό ν•λ” μ΄μ λ” μ½”λ“ν• μΈν”„λΌκ°€ μΌλ° μ½”λ”©κ³Ό λ‹¤λ¥Έ νΈλ μ΄λ“ μ¤ν”„λ¥Ό κ°–κΈ° λ•λ¬Έμ΄λ‹¤. </br>
μΈν”„λΌλ¥Ό μ μ–΄ν•λ” μ½”λ“λ¥Ό μ‘μ„±ν•  λ• λ²„κ·Έλ” λ¨λ“  μ•±, λ¨λ“  λ°μ΄ν„° μ €μ¥μ† λ° μ „μ²΄ λ„¤νΈμ›ν¬ ν† ν΄λ΅μ§€, κΈ°νƒ€λ¨λ“  μ”μ†λ¥Ό μ†μƒμ‹ν‚¬ μ μλ‹¤. </br>
λ”°λΌμ„ μ½”λ“ν• μΈν”„λΌ μ‘μ—…μ„ ν•  λ•λ” μΌλ°μ μΈ μ½”λ“λ³΄λ‹¤ λ” λ§μ€ 'μ•μ „ λ©”μ»¤λ‹μ¦'μ„ ν¬ν•¨ν•λ” κ²ƒμ΄ μΆ‹λ‹¤. </br>
